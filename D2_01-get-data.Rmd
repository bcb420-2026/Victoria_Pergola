# Get the data - Dataset 2 {#get-data_dataset2}

## Download the GEO supplementary file(s)

This chapter downloads it automatically using **GEOquery**.

```{r}
GSE_ID <- "GSE240829"

# Download supplementary files into ./data/GSE240829/
# (If already downloaded, GEOquery will reuse existing files.)

dir.create("data", showWarnings = FALSE)

supp <- GEOquery::getGEOSuppFiles(
  GSE_ID,
  makeDirectory = TRUE,
  baseDir = "data"
)
```

## Read the FeatureCounts matrix

```{r}
counts_file <- file.path("data", GSE_ID, "GSE240829_POCROC_good.abundance.salmon.genes_8.14.23.txt.gz")
stopifnot(file.exists(counts_file))

fc <- readr::read_tsv(counts_file, show_col_types = FALSE)

# Peek at the columns
names(fc)[1:min(12, ncol(fc))]
```

### Build a counts matrix (genes Ã— samples)

```{r}
sample_cols <- colnames(fc)

counts <- fc %>%
  dplyr::select( all_of(sample_cols)) %>%
  as.data.frame()

rownames(counts) <- counts[,1]
counts[,1] <- NULL

counts <- as.matrix(counts)
#storage.mode(counts) <- "integer"

dim(counts)
counts[1:3, 1:3]
```

## Create metadata from sample names

Sample names in this series follow patterns like:

21020_0_ovary 
21020_2_lymph_node 
24487_0_l_ovary
...
Where the first number is the patient id, second number is whether it is primary or recurrent and the third is location.  It was separated really badly because there are underscores in the location name as well.  (l_ovary = left ovary). --> just grab the last token for the location

We will parse:

- 'patient' - patient id
- 'status' - primary, recurrent1, recurrent2, recurrent3
- 'location' - ovary, 

```{r}

#design matrix - 
samples <- colnames(counts)[1:ncol(counts)]
patient  <- unlist(lapply(samples,FUN =
                             function(x){unlist(strsplit(x,split = "_"))[1]}))       
status <- unlist(lapply(samples,FUN = 
                             function(x){unlist(strsplit(x,split = "_"))[2]}))     
location <- unlist(lapply(samples,FUN = 
                             function(x){
                               if(length(unlist(strsplit(x, "_"))) > 3){
                                 y <- paste(unlist(strsplit(x, "_"))[3:length(unlist(strsplit(x, "_")))],collapse ="_")
                               } else{
                                 y <- unlist(strsplit(x, "_"))[3]
                               }
                               return(y)
                               }))  
meta <- data.frame(samples, patient,status, location)


```

## Identifier mapping

```{r}
strip_ensembl_version <- function(x) sub("\\..*$", "", x)

kable_head <- function(x, n = 5, caption = NULL) {
  knitr::kable(utils::head(x, n), caption = caption)
}

mapped_counts <- data.frame(ensembl_gene_id = strip_ensembl_version(rownames(counts)),counts)
ids<- mapped_counts$ensembl_gene_id

if (any(grepl("^ENSG", strip_ensembl_version(ids)))) {
  library(biomaRt)
  ensembl_ids <- unique(strip_ensembl_version(ids))
  ensembl <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")

  map <- getBM(
    attributes = c("ensembl_gene_id", "hgnc_symbol"),
    filters = "ensembl_gene_id",
    values = ensembl_ids,
    mart = ensembl
  )

  kable_head(map, 10, paste(": mapping preview"))

counts_mapped <- mapped_counts %>%
    left_join(map, by = "ensembl_gene_id") %>%
  dplyr::select( ensembl_gene_id,hgnc_symbol, everything())


  kable_head(counts_mapped[, 1:min(8, ncol(counts_mapped))], 5, paste(": mapped table preview"))
}
```


## Save intermediate objects

```{r}
saveRDS(list(counts = counts, 
             meta = meta, 
             mappings = counts_mapped[,1:2]), file = "data/d2_counts_and_meta.rds")
```
