
# Differential expression with DESeq2 {#deseq2}

DESeq2 performs differential expression analysis for RNA-seq **count** data.

```{r}
obj <- readRDS("data/d1_qc_objects.rds")
dge_f <- obj$dge_f
meta <- obj$meta

library(DESeq2)

count_mat <- dge_f$counts
storage.mode(count_mat) <- "integer"
stopifnot(all(colnames(count_mat) == meta$sample))

dds <- DESeqDataSetFromMatrix(
  countData = count_mat,
  colData = as.data.frame(meta),
  design = ~ cellline + treatment
)

dds <- DESeq(dds)
```

## Results

```{r}
res_20_vs_nt <- results(dds, contrast = c("treatment", "20CTG", "NT"))
res_3_vs_nt <- results(dds, contrast = c("treatment", "3CTG", "NT"))
res_20_vs_3 <- results(dds, contrast = c("treatment", "20CTG", "3CTG"))

summary(res_20_vs_nt)
```

## Volcano (red=up, blue=down)

```{r}
library(ggplot2)
library(dplyr)
library(tibble)

vol <- as.data.frame(res_20_vs_nt) %>%
  rownames_to_column("gene") %>%
  mutate(
    neglog10p = -log10(pvalue),
    direction = case_when(
      !is.na(padj) & padj < 0.05 & log2FoldChange > 0 ~ "Up",
      !is.na(padj) & padj < 0.05 & log2FoldChange < 0 ~ "Down",
      TRUE ~ "Not sig"
    )
  )

ggplot(vol, aes(log2FoldChange, neglog10p)) +
  geom_point(aes(color = direction), alpha = 0.7, size = 1.2) +
  scale_color_manual(values = c(Up = "red", Down = "blue", `Not sig` = "grey70")) +
  theme_minimal() +
  labs(title = "DESeq2: 20CTG vs NT", x = "log2 FC", y = "-log10(p)", color = NULL)
```

```{r}
saveRDS(list(meta = meta, dds = dds, res_20_vs_nt = res_20_vs_nt,
             res_3_vs_nt = res_3_vs_nt, res_20_vs_3 = res_20_vs_3),
        file = "data/d1_deseq2_results.rds")
```
